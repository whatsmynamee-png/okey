<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PDKS Gaming â€” Okey</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&family=Crimson+Pro:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
<style>
:root{
  --felt:#1a5c2e;--felt2:#144d25;--gold:#c9a84c;--gold2:#e8c96d;
  --wood:#3d2208;--cream:#f5edd6;
  --red:#c0392b;--blue:#1a6bbf;--yellow:#b07d00;--black:#1a1a1a;
  --tw:46px;--th:68px;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{
  background:radial-gradient(ellipse at 40% 30%,#2a1505,#0d0702 100%);
  font-family:'Crimson Pro',serif;color:var(--cream);
  min-height:100vh;display:flex;flex-direction:column;align-items:center;
  padding:10px 6px 30px;
}
h1{font-family:'Cinzel Decorative',cursive;color:var(--gold);
  font-size:clamp(1rem,2.5vw,1.6rem);letter-spacing:3px;
  text-shadow:0 2px 12px rgba(201,168,76,.5);margin-bottom:2px;}
.sub{color:var(--gold2);opacity:.65;font-style:italic;font-size:.8rem;margin-bottom:10px;}

/* â•â• MASA â•â• */
.board{
  width:100%;max-width:1120px;
  background:radial-gradient(ellipse at 50% 45%,#1f6635,var(--felt2) 78%);
  border-radius:26px;
  border:4px solid var(--gold);
  box-shadow:0 0 0 8px var(--wood),0 0 70px rgba(0,0,0,.85),
             inset 0 0 100px rgba(0,0,0,.2);
  padding:16px 14px 14px;
  display:grid;
  grid-template-rows:auto auto auto;
  gap:10px;
}

/* â•â• KARÅI OYUNCU (Ã¼st orta) â•â• */
.opp-top-wrap{
  display:flex;flex-direction:column;align-items:center;gap:6px;
}
/* TaÅŸ sÄ±rtlarÄ± â€” yatay Ã§ubuklar */
.tiles-horiz{display:flex;gap:3px;justify-content:center;flex-wrap:wrap;}
.tb-h{
  width:10px;height:calc(var(--th)*0.72);
  background:linear-gradient(160deg,#6b4a14,#3a2407);
  border:1px solid rgba(201,168,76,.6);border-radius:3px;
  box-shadow:1px 1px 4px rgba(0,0,0,.7);
}

/* â•â• ORTA â•â• */
.mid{display:grid;grid-template-columns:170px 1fr 170px;gap:10px;align-items:center;}

/* Yan oyuncular */
.opp-side-wrap{
  display:flex;flex-direction:column;align-items:center;gap:6px;
}
.tiles-vert{display:flex;flex-direction:column;gap:3px;align-items:center;}
.tb-v{
  width:calc(var(--tw)*0.72);height:10px;
  background:linear-gradient(160deg,#6b4a14,#3a2407);
  border:1px solid rgba(201,168,76,.6);border-radius:3px;
  box-shadow:1px 1px 4px rgba(0,0,0,.7);
}

/* â•â• ORTA ALAN â•â• */
.center-area{
  display:flex;flex-direction:column;align-items:center;gap:10px;
}
.piles-row{display:flex;align-items:flex-end;justify-content:center;gap:18px;}
.pile-wrap{text-align:center;}
.pile-lbl{font-size:.6rem;color:var(--gold2);text-transform:uppercase;
  letter-spacing:1.5px;opacity:.75;margin-bottom:5px;}
.pile-cnt{font-size:.58rem;color:var(--cream);opacity:.5;margin-top:3px;}

/* Talon yÄ±ÄŸÄ±nÄ± â€” fiziksel gÃ¶rÃ¼nÃ¼m */
.talon-stack{
  position:relative;width:56px;height:82px;cursor:pointer;
  transition:filter .15s;
}
.talon-stack:hover{filter:brightness(1.15);}
.talon-stack.off{opacity:.35;cursor:default;pointer-events:none;}
.tc{
  position:absolute;
  width:48px;height:70px;
  background:linear-gradient(145deg,#6b4010,#3d2208,#6b4010);
  border:2px solid var(--gold);border-radius:7px;
  display:flex;align-items:center;justify-content:center;
  font-size:1.1rem;color:var(--gold);
  box-shadow:2px 2px 8px rgba(0,0,0,.8);
}
.tc:nth-child(1){top:8px;left:6px;transform:rotate(-3deg);}
.tc:nth-child(2){top:4px;left:3px;transform:rotate(-1.5deg);}
.tc:nth-child(3){top:0;left:0;transform:rotate(0deg);}

/* AtÄ±lan */
.discard-zone{
  width:58px;height:80px;
  border:2px dashed rgba(201,168,76,.28);border-radius:9px;
  position:relative;overflow:hidden;
  display:flex;align-items:center;justify-content:center;
  transition:border-color .2s,background .2s;
}
.discard-zone.can-take{
  border-color:var(--gold);background:rgba(201,168,76,.08);cursor:pointer;
}
.discard-zone>.tile{position:absolute;inset:0;width:100%;height:100%;}

/* â•â• ATILAN YIÄIN (rakip baÅŸÄ±na) â•â• */
.opp-label{
  font-size:.65rem;color:var(--gold2);text-transform:uppercase;
  letter-spacing:1px;text-align:center;
}
.opp-label.active{color:var(--gold);text-shadow:0 0 8px rgba(201,168,76,.6);}
.opp-count{font-size:.55rem;color:rgba(245,237,214,.5);text-align:center;margin-top:1px;}

.disc-pile{
  position:relative;width:38px;height:54px;margin:0 auto;
}
.disc-pile .dm{
  position:absolute;
  width:34px;height:50px;
  background:linear-gradient(160deg,#fdf5e0,#eedd bb);
  background:#f8f0d8;
  border:1px solid #b8a060;border-radius:4px;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  font-size:.72rem;font-weight:700;line-height:1.1;
  box-shadow:1px 2px 5px rgba(0,0,0,.55);
}
.disc-pile .dm:nth-child(1){top:6px;left:2px;transform:rotate(-4deg);}
.disc-pile .dm:nth-child(2){top:3px;left:1px;transform:rotate(-1.5deg);}
.disc-pile .dm:nth-child(3){top:0;left:0;transform:rotate(1deg);}
.disc-pile .dm.red{color:var(--red);}
.disc-pile .dm.blue{color:var(--blue);}
.disc-pile .dm.yellow{color:var(--yellow);}
.disc-pile .dm.black{color:var(--black);}
.disc-pile .dm.joker{background:linear-gradient(135deg,#fffbe8,#ffe87a);
  border-color:var(--gold);color:#8a6000;}
.disc-pile .dm.isokey{background:linear-gradient(135deg,#fffbe8,#ffe87a);border-color:#d4a800;}
.disc-lbl{font-size:.52rem;color:rgba(232,201,109,.55);text-align:center;margin-top:2px;}

/* â•â• TILE â•â• */
.tile{
  width:var(--tw);height:var(--th);
  background:linear-gradient(160deg,#fef6e2,#efe0bc);
  border:1.5px solid #c4a462;border-radius:6px;
  box-shadow:0 3px 7px rgba(0,0,0,.5),inset 0 1px 0 rgba(255,255,255,.75);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  cursor:grab;user-select:none;position:relative;flex-shrink:0;
  transition:transform .12s,box-shadow .12s,border-color .12s;
}
.tile:active{cursor:grabbing;}
.tile .tn{font-size:1.3rem;font-weight:700;line-height:1;}
.tile .ts{font-size:1rem;line-height:1;margin-top:2px;}
.tile.red .tn,.tile.red .ts{color:var(--red);}
.tile.blue .tn,.tile.blue .ts{color:var(--blue);}
.tile.yellow .tn,.tile.yellow .ts{color:var(--yellow);}
.tile.black .tn,.tile.black .ts{color:var(--black);}
.tile.joker{background:linear-gradient(135deg,#fffbe8,#ffe060);border-color:#c9a84c;}
.tile.joker .tn{color:#7a5500;font-size:.78rem;}
.tile.isokey{
  background:linear-gradient(135deg,#fffbe8,#ffdc50);
  border-color:#d0a000;
  box-shadow:0 0 10px rgba(208,160,0,.55),0 3px 7px rgba(0,0,0,.4);
}
.tile.sel{
  border-color:var(--gold);
  box-shadow:0 0 0 3px var(--gold),0 4px 10px rgba(0,0,0,.5);
  transform:translateY(-9px);z-index:10;
}
.tile.ghost{opacity:.18;}

/* â•â• OYUNCUNUN ELÄ° â•â• */
.my-section{
  /* ahÅŸap tahta â€” dÄ±ÅŸ sarmalayÄ±cÄ± */
  background:transparent;
  border:none;
  border-radius:14px;
  padding:0;
  position:relative;
  overflow:visible;
  box-shadow:0 10px 40px rgba(0,0,0,.75),0 4px 12px rgba(0,0,0,.5);
}

/* Ãœst kenar ÅŸeridi */
.my-section::before{
  content:'';
  display:block;height:12px;
  background:linear-gradient(180deg,#3d1c06 0%,#6a3410 40%,#4a2208 100%);
  border-radius:10px 10px 0 0;
  border:2px solid #2a1204;border-bottom:3px solid #8a4a18;
  box-shadow:0 3px 6px rgba(0,0,0,.5),inset 0 1px 0 rgba(255,255,255,.08);
}
/* Alt kenar ÅŸeridi */
.my-section::after{
  content:'';
  display:block;height:14px;
  background:linear-gradient(180deg,#6a3410 0%,#3d1c06 60%,#261004 100%);
  border-radius:0 0 12px 12px;
  border:2px solid #2a1204;border-top:3px solid #8a4a18;
  box-shadow:0 6px 12px rgba(0,0,0,.6);
}

/* AhÅŸap gÃ¶vde â€” iÃ§erik alanÄ± */
.wood-inner{
  background:
    repeating-linear-gradient(90deg,
      rgba(0,0,0,.0) 0px, rgba(0,0,0,.0) 60px,
      rgba(0,0,0,.04) 61px, rgba(0,0,0,.0) 62px
    ),
    repeating-linear-gradient(180deg,
      rgba(255,255,255,.03) 0px, rgba(255,255,255,.0) 2px,
      rgba(0,0,0,.0) 3px, rgba(0,0,0,.0) 28px
    ),
    linear-gradient(178deg,
      #d4883c 0%,#b86828 12%,#ca7c34 24%,
      #a85e20 36%,#be7230 48%,#a35820 60%,
      #c07230 72%,#a86028 84%,#b86c2e 100%
    );
  border-left:3px solid #5a2e0a;
  border-right:3px solid #5a2e0a;
  padding:8px 12px 6px;
  position:relative;
}

/* Yiv â€” taÅŸlarÄ±n oturduÄŸu kanal */
.groove{
  height:5px;
  background:linear-gradient(180deg,#2a1004 0%,#5a2e0a 40%,#2a1004 100%);
  border-radius:3px;
  box-shadow:inset 0 2px 4px rgba(0,0,0,.7),0 1px 1px rgba(255,255,255,.05);
  margin:5px 0 4px;
}

.rack-header{
  display:flex;justify-content:space-between;align-items:center;
  margin-bottom:6px;flex-wrap:wrap;gap:5px;
}
.rack-title{
  font-family:'Cinzel Decorative',cursive;
  color:#f0c870;font-size:.72rem;
  text-shadow:0 1px 4px rgba(0,0,0,.6),0 0 8px rgba(180,120,0,.4);
}
.rack-grid{
  display:grid;
  grid-template-columns:repeat(15,var(--tw));
  grid-template-rows:repeat(2,var(--th));
  gap:5px 3px;overflow-x:auto;
}

/* Yuva â€” oyulmuÅŸ ahÅŸap gÃ¶rÃ¼nÃ¼mÃ¼ */
.slot{
  width:var(--tw);height:var(--th);
  background:
    linear-gradient(160deg,
      #7a3c0e 0%,#5a2a08 25%,
      #6a3410 50%,#4e2206 75%,
      #603010 100%
    );
  border-radius:5px;
  border:1px solid #3a1804;
  border-top:2px solid #2a1004;
  border-bottom:1px solid #8a4a18;
  box-shadow:
    inset 0 3px 6px rgba(0,0,0,.6),
    inset 0 -1px 2px rgba(255,255,255,.06),
    inset 2px 0 4px rgba(0,0,0,.3),
    inset -2px 0 4px rgba(0,0,0,.3);
  position:relative;cursor:pointer;
  transition:box-shadow .15s;
}
/* Ä°Ã§ aydÄ±nlatma Ã§izgisi */
.slot::before{
  content:'';position:absolute;
  top:3px;left:4px;right:4px;height:1px;
  background:rgba(255,255,255,.07);border-radius:1px;
}
.slot.dov{
  box-shadow:
    inset 0 3px 6px rgba(0,0,0,.4),
    0 0 0 2px var(--gold),
    0 0 8px rgba(201,168,76,.3);
}
.slot>.tile{position:absolute;inset:0;width:100%;height:100%;}

/* â•â• INFO â•â• */
.info-bar{display:flex;gap:7px;justify-content:center;align-items:center;flex-wrap:wrap;}
.chip{background:rgba(0,0,0,.45);border:1px solid rgba(201,168,76,.28);
  border-radius:20px;padding:2px 10px;font-size:.7rem;color:var(--gold2);}
.chip.blink{border-color:var(--gold);color:var(--gold);animation:blink 1.3s infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
.status{text-align:center;font-style:italic;font-size:.76rem;
  color:var(--gold2);min-height:22px;margin-top:4px;}
.status.err{color:#e74c3c;}.status.ok{color:#27ae60;}

/* â•â• BUTONLAR â•â• */
.btn{
  background:linear-gradient(135deg,#8a5f08,var(--gold),#8a5f08);
  border:none;color:#160e02;
  font-family:'Crimson Pro',serif;font-weight:700;font-size:.76rem;
  padding:5px 14px;border-radius:20px;cursor:pointer;
  box-shadow:0 2px 8px rgba(0,0,0,.55);
  transition:transform .12s,box-shadow .12s;
}
.btn:hover{transform:translateY(-1px);box-shadow:0 4px 14px rgba(0,0,0,.65);}
.btn:disabled{opacity:.28;cursor:not-allowed;transform:none;}
.btn.ghost{background:transparent;border:1.5px solid var(--gold);color:var(--gold);}
.btn.danger{background:linear-gradient(135deg,#5c0e0e,#c0392b,#5c0e0e);color:#fff;}
.btns{display:flex;gap:6px;align-items:center;flex-wrap:wrap;}
.rules-hint{font-size:.63rem;color:rgba(245,237,214,.4);margin-top:5px;line-height:1.5;}
.rules-hint b{color:rgba(232,201,109,.65);}

/* â•â• WIN MODAL â•â• */
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.88);
  z-index:400;align-items:center;justify-content:center;padding:16px;}
.overlay.show{display:flex;}

.win-modal{
  background:linear-gradient(145deg,#1e1005,#0e0802);
  border:2px solid var(--gold);border-radius:22px;
  padding:24px 28px 28px;
  text-align:center;
  box-shadow:0 0 100px rgba(201,168,76,.35);
  max-width:900px;width:100%;
  animation:popIn .4s cubic-bezier(.175,.885,.32,1.275);
}
@keyframes popIn{from{transform:scale(.7);opacity:0}to{transform:scale(1);opacity:1}}

.win-header{margin-bottom:16px;}
.win-confetti{font-size:2.2rem;animation:spin 1s ease-out;}
@keyframes spin{from{transform:rotate(-20deg) scale(.5)}to{transform:rotate(0) scale(1)}}
.win-modal h2{
  font-family:'Cinzel Decorative',cursive;color:var(--gold);
  font-size:clamp(1.1rem,3vw,1.7rem);margin:6px 0 4px;
  text-shadow:0 0 20px rgba(201,168,76,.6);
}
.win-modal p{color:var(--cream);font-size:.88rem;opacity:.8;}

/* Kazanan tahtasÄ± */
.win-board-wrap{
  overflow-x:auto;
  border-radius:12px;
}
.win-board{
  display:inline-block;min-width:min-content;
  box-shadow:0 10px 40px rgba(0,0,0,.7),0 4px 10px rgba(0,0,0,.5);
  border-radius:12px;
}
.win-board-top-rail,.win-board-bot-rail{
  height:12px;
  background:linear-gradient(180deg,#3d1c06,#6a3410,#4a2208);
  border:2px solid #2a1204;
}
.win-board-top-rail{
  border-radius:10px 10px 0 0;
  border-bottom:3px solid #8a4a18;
  box-shadow:0 3px 6px rgba(0,0,0,.5);
}
.win-board-bot-rail{
  border-radius:0 0 10px 10px;
  border-top:3px solid #8a4a18;
  background:linear-gradient(180deg,#6a3410,#3d1c06,#261004);
  box-shadow:0 5px 10px rgba(0,0,0,.6);
}
.win-board-body{
  background:
    repeating-linear-gradient(90deg,
      rgba(0,0,0,.0) 0px,rgba(0,0,0,.0) 58px,
      rgba(0,0,0,.04) 59px,rgba(0,0,0,.0) 60px
    ),
    linear-gradient(178deg,
      #d4883c 0%,#b86828 12%,#ca7c34 24%,
      #a85e20 36%,#be7230 48%,#a35820 60%,
      #c07230 72%,#a86028 84%,#b86c2e 100%
    );
  border-left:3px solid #5a2e0a;
  border-right:3px solid #5a2e0a;
  padding:6px 12px;
}
.win-groove{
  height:5px;
  background:linear-gradient(180deg,#2a1004,#5a2e0a,#2a1004);
  border-radius:3px;
  box-shadow:inset 0 2px 4px rgba(0,0,0,.7);
  margin:4px 0;
}
.win-rack{
  display:flex;gap:3px;flex-wrap:nowrap;
  padding:2px 0;
  min-width:min-content;
}
/* Her taÅŸ yuvasÄ± */
.win-slot{
  width:var(--tw);height:var(--th);flex-shrink:0;
  background:linear-gradient(160deg,#7a3c0e,#5a2a08,#6a3410,#4e2206,#603010);
  border-radius:5px;
  border:1px solid #3a1804;
  border-top:2px solid #2a1004;
  border-bottom:1px solid #8a4a18;
  box-shadow:inset 0 3px 6px rgba(0,0,0,.6),inset 0 -1px 2px rgba(255,255,255,.06);
  position:relative;
}
.win-slot>.tile{
  position:absolute;inset:0;width:100%;height:100%;cursor:default;
  animation:tileSlide .3s ease-out both;
}
@keyframes tileSlide{from{transform:translateY(-12px);opacity:0}to{transform:translateY(0);opacity:1}}

/* â•â• RESPONSIVE â•â• */
@media(max-width:880px){
  .mid{grid-template-columns:130px 1fr 130px;}
  :root{--tw:40px;--th:58px;}
}
@media(max-width:580px){
  .mid{grid-template-columns:90px 1fr 90px;}
  :root{--tw:30px;--th:46px;}
  .tile .tn{font-size:1rem;}.tile .ts{font-size:.8rem;}
  .rack-grid{gap:2px;}
}
</style>
</head>
<body>
<h1>âœ¦ PDKS GAMING âœ¦</h1>
<p class="sub">4 KiÅŸilik TÃ¼rk Okey</p>

<div class="board">

  <!-- â•â•â• ÃœST: KARÅI OYUNCU (O3) â•â•â• -->
  <div class="opp-top-wrap" id="ow1">
    <div class="opp-label" id="o1n">Oyuncu 3</div>
    <div class="tiles-horiz" id="o1t"></div>
    <div class="disc-pile" id="o1d"></div>
    <div class="disc-lbl" id="o1dl"></div>
  </div>

  <!-- â•â•â• ORTA SIRA â•â•â• -->
  <div class="mid">

    <!-- Sol: Oyuncu 2 -->
    <div class="opp-side-wrap" id="ow0">
      <div class="opp-label" id="o0n">Oyuncu 2</div>
      <div class="tiles-vert" id="o0t"></div>
      <div class="disc-pile" id="o0d"></div>
      <div class="disc-lbl" id="o0dl"></div>
    </div>

    <!-- Merkez -->
    <div class="center-area">
      <div class="piles-row">

        <div class="pile-wrap">
          <div class="pile-lbl">Talon</div>
          <div class="talon-stack" id="tlnDiv" onclick="hDraw()">
            <div class="tc"></div>
            <div class="tc"></div>
            <div class="tc">âœ¦</div>
          </div>
          <div class="pile-cnt" id="pc">â€”</div>
        </div>

        <div class="pile-wrap" style="text-align:center;">
          <div class="pile-lbl">GÃ¶sterge / Okey</div>
          <div id="okw" style="display:inline-block;"></div>
          <div id="okeyLbl" style="font-size:.55rem;color:var(--gold2);opacity:.75;margin-top:3px;"></div>
        </div>

        <div class="pile-wrap">
          <div class="pile-lbl">AtÄ±lan</div>
          <div class="discard-zone" id="da" onclick="hTakeDiscard()"></div>
        </div>

      </div>

      <div class="info-bar">
        <div class="chip" id="tc">ğŸ² SÄ±ra: Sen</div>
        <div class="chip" id="phc">TaÅŸ Ã§ek</div>
        <div class="chip" id="hc">14 taÅŸ</div>
      </div>
      <div class="status" id="st">Talon'dan veya atÄ±landan taÅŸ Ã§ekin.</div>
    </div>

    <!-- SaÄŸ: Oyuncu 4 -->
    <div class="opp-side-wrap" id="ow2">
      <div class="opp-label" id="o2n">Oyuncu 4</div>
      <div class="tiles-vert" id="o2t"></div>
      <div class="disc-pile" id="o2d"></div>
      <div class="disc-lbl" id="o2dl"></div>
    </div>

  </div>

  <!-- â•â•â• ALT: OYUNCUNUN ELÄ° â•â•â• -->
  <div class="my-section">
    <div class="wood-inner">
      <div class="rack-header">
        <div class="rack-title">ğŸ«µ Senin TaÅŸlarÄ±n</div>
        <div class="btns">
          <button class="btn ghost" onclick="autoSort()">SÄ±rala</button>
          <button class="btn" id="bd" onclick="discardSel()" disabled>TaÅŸ At</button>
          <button class="btn danger" id="bo" onclick="declOkey()" disabled>OKEY!</button>
        </div>
      </div>
      <div class="groove"></div>
      <div class="rack-grid" id="rg"></div>
      <div class="groove"></div>
      <div class="rules-hint">
        <b>KazanÄ±ÅŸ:</b> 14 taÅŸÄ±n tamamÄ±nÄ± geÃ§erli gruplara bÃ¶l (en az 3 taÅŸ/grup).
        <b>Set:</b> aynÄ± sayÄ± farklÄ± renkler &nbsp;|&nbsp; <b>Seri:</b> aynÄ± renk ardÄ±ÅŸÄ±k sayÄ±lar (5-6-7'lik de geÃ§er).
        Okey âœ¦ ve Joker â˜… herhangi bir taÅŸÄ±n yerini alÄ±r.
      </div>
    </div>
  </div>

</div>

<div class="overlay" id="ov">
  <div class="win-modal">
    <div class="win-header">
      <div class="win-confetti" id="wconf">ğŸ‰</div>
      <h2 id="mt"></h2>
      <p id="mb"></p>
    </div>
    <!-- Kazanan tahtasÄ± -->
    <div class="win-board-wrap">
      <div class="win-board">
        <div class="win-board-top-rail"></div>
        <div class="win-board-body">
          <div class="win-groove"></div>
          <div class="win-rack" id="wh"></div>
          <div class="win-groove"></div>
        </div>
        <div class="win-board-bot-rail"></div>
      </div>
    </div>
    <button class="btn" style="margin-top:18px;" onclick="init()">Yeni Oyun</button>
  </div>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TÃœRK OKEY â€” ENGINE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const CLR=['red','blue','yellow','black'];
const SYM={red:'â—',blue:'â—',yellow:'â—',black:'â—'};
const COLS=15,ROWS=2,SL=COLS*ROWS;
let G={};

function bDeck(){
  let id=0,d=[];
  for(let c=0;c<2;c++) for(const cl of CLR) for(let n=1;n<=13;n++)
    d.push({id:id++,cl,num:n,j:false,fj:false});
  d.push({id:id++,cl:'joker',num:0,j:true,fj:true});
  d.push({id:id++,cl:'joker',num:0,j:true,fj:true});
  return shuf(d);
}
function shuf(a){for(let i=a.length-1;i>0;i--){const j=Math.random()*i|0;[a[i],a[j]]=[a[j],a[i]];}return a;}
function isOkey(t){return !t.fj&&t.cl===G.oc&&t.num===G.on;}
function isJoker(t){return t.fj||isOkey(t);}

function init(){
  document.getElementById('ov').classList.remove('show');
  document.getElementById('wh').innerHTML='';
  const dk=bDeck();
  const ind=dk.pop();
  const oc=ind.fj?'red':ind.cl;
  const on=ind.fj?1:(ind.num===13?1:ind.num+1);
  const hs=[[],[],[],[]];
  for(let p=0;p<4;p++) for(let i=0;i<14;i++) hs[p].push(dk.pop());
  const rack=Array(SL).fill(null);
  hs[0].forEach((t,i)=>{rack[i]=t;});
  G={dk,on,oc,ind,rack,opp:[hs[1],hs[2],hs[3]],oppDis:[[],[],[]],
    dis:[],turn:0,phase:'draw',sel:null,dsrc:null,over:false};
  render();
  ss("Talon'dan veya atÄ±lan taÅŸtan taÅŸ Ã§ekin.");
}

/* â”€â”€ RENDER â”€â”€ */
function render(){rInd();rOpps();rRack();rDis();rCenter();rUI();}

function rInd(){
  const w=document.getElementById('okw');w.innerHTML='';
  const el=mkTile(G.ind);el.style.cursor='default';el.draggable=false;w.appendChild(el);
  const cn={red:'KÄ±rmÄ±zÄ±',blue:'Mavi',yellow:'SarÄ±',black:'Siyah'};
  document.getElementById('okeyLbl').textContent='Okey: '+G.on+' '+(cn[G.oc]||'');
}

function rOpps(){
  const names=['Oyuncu 2','Oyuncu 3','Oyuncu 4'];
  for(let i=0;i<3;i++){
    const h=G.opp[i];
    const active=G.turn===i+1;
    // Ä°sim
    const lbl=document.getElementById('o'+i+'n');
    lbl.textContent=(active?'â–¶ ':'')+names[i]+' Â· '+h.length+' taÅŸ';
    lbl.className='opp-label'+(active?' active':'');
    // TaÅŸ sÄ±rtlarÄ±
    const td=document.getElementById('o'+i+'t');td.innerHTML='';
    const cls=i===1?'tb-h':'tb-v';
    h.forEach(()=>{const d=document.createElement('div');d.className=cls;td.appendChild(d);});
    // AtÄ±lan yÄ±ÄŸÄ±n
    const dd=document.getElementById('o'+i+'d');dd.innerHTML='';
    const dl=document.getElementById('o'+i+'dl');
    const stack=G.oppDis[i];
    if(stack.length){
      stack.slice(-3).forEach(t=>{dd.appendChild(mkMini(t));});
      dl.textContent=stack.length+' atÄ±lan';
    } else dl.textContent='';
  }
}

function rRack(){
  const rg=document.getElementById('rg');rg.innerHTML='';
  for(let s=0;s<SL;s++){
    const sl=document.createElement('div');sl.className='slot';
    sl.addEventListener('dragover',e=>{e.preventDefault();sl.classList.add('dov');});
    sl.addEventListener('dragleave',()=>sl.classList.remove('dov'));
    sl.addEventListener('drop',e=>{e.preventDefault();sl.classList.remove('dov');onDrop(s);});
    sl.addEventListener('click',()=>onSC(s));
    const t=G.rack[s];
    if(t){
      const el=mkTile(t);
      if(G.sel===s)el.classList.add('sel');
      el.draggable=true;
      el.addEventListener('dragstart',()=>{G.dsrc=s;setTimeout(()=>el.classList.add('ghost'),0);});
      el.addEventListener('dragend',()=>{el.classList.remove('ghost');G.dsrc=null;});
      el.addEventListener('click',e=>{e.stopPropagation();onSC(s);});
      sl.appendChild(el);
    }
    rg.appendChild(sl);
  }
}

function rDis(){
  const da=document.getElementById('da');da.innerHTML='';
  const canTake=G.phase==='draw'&&G.turn===0&&G.dis.length>0;
  da.className='discard-zone'+(canTake?' can-take':'');
  if(G.dis.length){
    const el=mkTile(G.dis[G.dis.length-1]);
    el.style.cssText='position:absolute;inset:0;width:100%;height:100%;';
    el.style.cursor=canTake?'pointer':'default';
    el.draggable=false;da.appendChild(el);
  }
}

function rCenter(){
  document.getElementById('pc').textContent=G.dk.length+' taÅŸ';
  const tln=document.getElementById('tlnDiv');
  const canDraw=G.turn===0&&G.phase==='draw'&&G.dk.length>0;
  tln.classList.toggle('off',!canDraw);
}

function rUI(){
  const my=G.turn===0;
  const nm=['Sen','Oyuncu 2','Oyuncu 3','Oyuncu 4'];
  const tc=document.getElementById('tc');
  tc.textContent='ğŸ² SÄ±ra: '+nm[G.turn];tc.classList.toggle('blink',my);
  document.getElementById('phc').textContent=G.phase==='draw'?'TaÅŸ Ã§ek':'TaÅŸ at';
  document.getElementById('hc').textContent=G.rack.filter(Boolean).length+' taÅŸ';
  const hasSel=G.sel!==null&&G.rack[G.sel]!=null;
  document.getElementById('bd').disabled=!(my&&G.phase==='discard'&&hasSel);
  document.getElementById('bo').disabled=!(my&&G.phase==='discard');
}

/* â”€â”€ TILE BUILDERS â”€â”€ */
function mkTile(t){
  const el=document.createElement('div');
  const ok=isOkey(t);
  if(t.fj){
    el.className='tile joker';
    el.innerHTML='<span class="tn">â˜…</span><span class="ts" style="font-size:.52rem;color:#7a5500;">JOKER</span>';
  } else if(ok){
    el.className='tile '+t.cl+' isokey';
    el.innerHTML='<span class="tn">'+t.num+'</span><span class="ts">âœ¦</span>';
    el.title='OKEY taÅŸÄ±!';
  } else {
    el.className='tile '+t.cl;
    el.innerHTML='<span class="tn">'+t.num+'</span><span class="ts">'+SYM[t.cl]+'</span>';
  }
  return el;
}

function mkMini(t){
  const el=document.createElement('div');
  if(t.fj){el.className='dm joker';el.textContent='â˜…';}
  else if(isOkey(t)){el.className='dm isokey '+t.cl;el.innerHTML=t.num+'<br>âœ¦';}
  else{el.className='dm '+t.cl;el.textContent=t.num;}
  return el;
}

/* â”€â”€ INTERACTION â”€â”€ */
function onSC(s){
  if(G.turn!==0||G.phase!=='discard')return;
  if(!G.rack[s]){
    if(G.sel!==null&&G.rack[G.sel]){G.rack[s]=G.rack[G.sel];G.rack[G.sel]=null;G.sel=null;}
  } else G.sel=(G.sel===s)?null:s;
  rRack();rUI();
}
function onDrop(to){
  const fr=G.dsrc;if(fr===null||fr===to)return;
  [G.rack[fr],G.rack[to]]=[G.rack[to],G.rack[fr]];
  if(G.sel===fr)G.sel=to;G.dsrc=null;rRack();rUI();
}

function hDraw(){
  if(G.turn!==0||G.phase!=='draw')return;
  if(!G.dk.length){ss('Talon bitti!','err');return;}
  addRack(G.dk.pop());G.phase='discard';render();
  ss('TaÅŸ Ã§ekildi. Atmak istediÄŸiniz taÅŸÄ± seÃ§ip "TaÅŸ At"a basÄ±n.');
}
function hTakeDiscard(){
  if(G.turn!==0||G.phase!=='draw')return;
  if(!G.dis.length){ss('AtÄ±lan taÅŸ yok.','err');return;}
  addRack(G.dis.pop());G.phase='discard';render();
  ss('AtÄ±lan taÅŸÄ± aldÄ±nÄ±z. Bir taÅŸ atÄ±n.');
}
function addRack(t){const i=G.rack.indexOf(null);if(i!==-1)G.rack[i]=t;}

function discardSel(){
  if(G.turn!==0||G.phase!=='discard')return;
  if(G.sel===null||!G.rack[G.sel]){ss('Ã–nce atmak istediÄŸiniz taÅŸÄ± seÃ§in.','err');return;}
  const t=G.rack[G.sel];G.rack[G.sel]=null;G.dis.push(t);G.sel=null;
  G.phase='draw';G.turn=1;render();ss('TaÅŸ atÄ±ldÄ±. Rakipler oynuyorâ€¦');
  setTimeout(runOpps,700);
}

function autoSort(){
  const tiles=G.rack.filter(Boolean);
  tiles.sort((a,b)=>{
    const ja=isJoker(a),jb=isJoker(b);
    if(ja&&!jb)return -1;if(!ja&&jb)return 1;
    const ci=CLR.indexOf(a.cl)-CLR.indexOf(b.cl);
    return ci!==0?ci:a.num-b.num;
  });
  G.rack=Array(SL).fill(null);tiles.forEach((t,i)=>{G.rack[i]=t;});
  G.sel=null;rRack();rUI();
}

/* â”€â”€ OKEY BEYAN â”€â”€ */
function declOkey(){
  if(G.turn!==0||G.phase!=='discard')return;
  const h=G.rack.filter(Boolean);
  if(h.length===15){
    if(G.sel===null||!G.rack[G.sel]){
      ss("Ã–nce atacaÄŸÄ±nÄ±z taÅŸÄ± seÃ§in, sonra OKEY'e basÄ±n.",'err');return;
    }
    const st=G.rack[G.sel];
    const h14=h.filter(t=>t!==st);
    if(valH(h14)){
      G.over=true;G.rack[G.sel]=null;G.dis.push(st);
      showWin('ğŸ‰ Tebrikler! OKEY!','Eliniz geÃ§erli â€” Okey yaptÄ±nÄ±z!',h14);
    } else ss('Eliniz henÃ¼z geÃ§erli deÄŸil.','err');
  } else if(h.length===14){
    if(valH(h)){G.over=true;showWin('ğŸ‰ Tebrikler! OKEY!','Eliniz geÃ§erli!',h);}
    else ss('Eliniz henÃ¼z geÃ§erli deÄŸil.','err');
  } else ss('Elinizde '+h.length+' taÅŸ var, 14 ya da 15 olmalÄ±.','err');
}

/* â”€â”€ AI â”€â”€ */
function runOpps(){
  if(G.over)return;
  let opp=0;
  function nxt(){
    if(opp>2){G.turn=0;G.phase='draw';render();ss('SÄ±ra sizde!');return;}
    G.turn=opp+1;render();
    setTimeout(()=>{
      if(G.over)return;
      const h=G.opp[opp];
      if(G.dk.length)h.push(G.dk.pop());else if(G.dis.length)h.push(G.dis.pop());
      if(h.length>=15){
        let won=false;
        for(let ei=0;ei<h.length;ei++){
          const test=h.filter((_,i)=>i!==ei);
          if(test.length===14&&valH(test)){won=true;break;}
        }
        if(won){
          G.over=true;
          showWin('Oyuncu '+(opp+2)+' KazandÄ±!','Oyuncu '+(opp+2)+' Okey yaptÄ±!',[]);
          return;
        }
      }
      const wi=aiWIdx(h);
      const disc=h.splice(wi,1)[0];
      G.oppDis[opp].push(disc);G.dis.push(disc);
      opp++;render();setTimeout(nxt,420);
    },480);
  }
  nxt();
}

function aiWIdx(h){
  function sc(t){
    if(isJoker(t))return 9999;
    let s=0;
    h.forEach(o=>{
      if(o===t)return;
      if(o.num===t.num&&o.cl!==t.cl)s+=3;
      if(o.cl===t.cl&&Math.abs(o.num-t.num)===1)s+=2;
      if(o.cl===t.cl&&Math.abs(o.num-t.num)===2)s+=1;
    });
    return s;
  }
  let mi=0,mv=Infinity;
  h.forEach((t,i)=>{const v=sc(t);if(v<mv){mv=v;mi=i;}});
  return mi;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VALIDATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function valH(hand){
  if(hand.length!==14)return false;
  const jCount=hand.filter(isJoker).length;
  const normals=hand.filter(t=>!isJoker(t));
  for(const part of genPartitions(14,3)){
    if(solveGroups(normals.slice(),jCount,part,0))return true;
  }
  return false;
}
function genPartitions(n,minG){
  if(n===0)return[[]];if(n<minG)return[];
  const res=[];
  for(let g=minG;g<=n;g++)
    for(const rest of genPartitions(n-g,minG))
      res.push([g,...rest]);
  return res;
}
function solveGroups(tiles,jLeft,sizes,idx){
  if(idx===sizes.length)return tiles.length===0;
  const sz=sizes[idx];
  for(const {used,jUsed} of genGroups(tiles,jLeft,sz)){
    const rem=tiles.filter((_,i)=>!used.includes(i));
    if(solveGroups(rem,jLeft-jUsed,sizes,idx+1))return true;
  }
  return false;
}
function genGroups(tiles,jLeft,sz){
  const res=[];
  if(sz<=4){
    const byN={};tiles.forEach((t,i)=>{(byN[t.num]=byN[t.num]||[]).push(i);});
    for(const num in byN){
      const idxs=byN[num];
      for(let ju=0;ju<=Math.min(jLeft,sz-1);ju++){
        const need=sz-ju;if(need>idxs.length||need<1)continue;
        for(const combo of combinations(idxs,need)){
          const clrs=combo.map(i=>tiles[i].cl);
          if(new Set(clrs).size===clrs.length)res.push({used:combo,jUsed:ju});
        }
      }
    }
  }
  if(sz<=13){
    for(const cl of CLR){
      const cIdx=tiles.map((t,i)=>i).filter(i=>tiles[i].cl===cl);
      cIdx.sort((a,b)=>tiles[a].num-tiles[b].num);
      const tried=new Set();
      for(const si of cIdx){
        const sn=tiles[si].num;
        for(let off=0;off<sz;off++){
          const s=sn-off;if(s<1||s+sz-1>13)continue;
          const key=cl+s+'_'+sz;if(tried.has(key))continue;tried.add(key);
          const used=[];let ju=0;let ok=true;const us=new Set();
          for(let k=0;k<sz;k++){
            const nd=s+k;
            const f=cIdx.find(i=>tiles[i].num===nd&&!us.has(i));
            if(f!==undefined){us.add(f);used.push(f);}
            else if(ju<jLeft)ju++;
            else{ok=false;break;}
          }
          if(ok)res.push({used,jUsed:ju});
        }
      }
    }
  }
  return res;
}
function combinations(arr,k){
  if(k===0)return[[]];if(arr.length<k)return[];
  const[f,...r]=arr;
  return[...combinations(r,k-1).map(c=>[f,...c]),...combinations(r,k)];
}

function ss(m,c){const e=document.getElementById('st');e.textContent=m;e.className='status'+(c?' '+c:'');}

function showWin(title,body,hand){
  document.getElementById('mt').textContent=title;
  document.getElementById('mb').textContent=body;
  const wh=document.getElementById('wh');wh.innerHTML='';
  // TaÅŸlarÄ± Ä±stakaya yerleÅŸtir â€” 15 slot, boÅŸluklarÄ± da gÃ¶ster
  const slots=Math.max(hand.length,14);
  hand.forEach((t,i)=>{
    const slot=document.createElement('div');slot.className='win-slot';
    const el=mkTile(t);
    el.draggable=false;
    el.style.animationDelay=(i*0.04)+'s';
    slot.appendChild(el);
    wh.appendChild(slot);
  });
  // Kalan boÅŸ yuvalar
  for(let i=hand.length;i<slots;i++){
    const slot=document.createElement('div');slot.className='win-slot';
    wh.appendChild(slot);
  }
  document.getElementById('ov').classList.add('show');
}

init();
</script>
</body>
</html>
